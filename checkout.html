<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Checkout - QuackCommerce.com</title>
        <link rel="icon" type="image/png" href="images/logo/site-logo-only.jpg">
        <!-- MATERIAL DESIGN ICONIC FONT -->
		<link rel="stylesheet" href="fonts/material-design-iconic-font/css/material-design-iconic-font.min.css">
        <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" >
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.css" integrity="sha512-UTNP5BXLIptsaj5WdKFrkFov94lDx+eBvbKyoe1YAfjeRPC+gT5kyZ10kOHCfNZqEui1sxmqvodNUx3KbuYI/A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <link rel="stylesheet" href="css/helper.css">
        <link rel="stylesheet" href="style.css">
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const urlParams = new URLSearchParams(window.location.search);
                const fromCart = urlParams.get('fromCart');
                
                if (!fromCart) {
                    window.location.href = 'shopping-cart.html'; // Redirect to shopping-cart.html if accessed directly
                }
            });
        </script>
    </head>
    <body>
        <!-- Begin Body Wrapper -->
        <div class="body-wrapper">
            <!-- Begin Header Area -->
            <header class="header">
                <!-- Begin Header Top Area -->
                <div class="header-top">
                    <div class="container">
                        <div class="ht-menu">
                            <span>Telephone Enquiry: 1-(800)-876-543</span>
                            <ul>
                                <li><a href="index.html">Home</a></li>
                                <li><a href="account-basic-info.html">My Account</a></li>
                                <li><a href="shopping-cart.html">Cart</a></li>
                                <li><a id="sign-in-link" href="sign-in.html">Sign In</a></li>    
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Header Top Area End Here -->
                <!-- Begin Header Middle Area -->
                <div class="header-middle">
                    <div class="container">
                        <div class="row">
                            <div class="col-3">
                                <div class="logo">
                                    <a href="index.html">
                                        <img src="images/logo/site-logo-only.jpg" alt="" style="width: 18%;">
                                        <span>QuackCommerce</span> 
                                    </a>
                                </div>
                            </div>
                            <div class="col-9">
                                <div class="hm-searchbox-area">
                                    <div class="hm-searchbox">
                                        <form id="searchForm">
                                            <select id="categorySelect">
                                                <option value="0">All</option>                         
                                                <option value="1">Laptops & Tablets</option>                     
                                                <option value="2">Electronics & Accessories</option>    
                                                <option value="3">Printers</option>
                                            </select>
                                            <input id="searchInput" type="text" placeholder="Search for anything at QuackCommerce online">
                                        </form>                                                                           
                                    </div>
                                    <p><a href="account-basic-info.html">Hello, <span id="greet-user">guest</span></a></p>
                                    <div class="cart-container">
                                        <a href="shopping-cart.html">
                                            <img src="images/icon/cart.png" alt="" width="50px">
                                            <span id="cart-number" class="cart-number">0</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Header Middle Area End Here -->
                <!-- Begin Header Bottom Area -->
                <div class="header-bottom header-sticky">
                    <div class="container">
                        <div class="hb-menu">
                            <nav>
                                <ul>
                                    <li class="dropdown-holder"><a href="product-grid-category.html?categoryId=1&categoryName=Laptops%20%26%20Tablets">Laptops & Tablets</a>
                                        <ul class="hb-dropdown">
                                            <li><a href="product-grid-category.html?categoryId=1&categoryName=Laptops%20%26%20Tablets&subcategoryId=1&subcategoryName=Laptops">Laptops</a></li>
                                            <li><a href="product-grid-category.html?categoryId=1&categoryName=Laptops%20%26%20Tablets&subcategoryId=2&subcategoryName=Tablets">Tablets</a></li>
                                        </ul>
                                    </li>
                                    <li class="dropdown-holder"><a href="product-grid-category.html?categoryId=2&categoryName=Electronics%20%26%20Accessories">Electronics & Accessories</a>
                                        <ul class="hb-dropdown">
                                            <li><a href="product-grid-category.html?categoryId=2&categoryName=Electronics%20%26%20Accessories&subcategoryId=3&subcategoryName=Keyboards%20%26%20Mice">Keyboards & Mice</a></li>
                                            <li><a href="product-grid-category.html?categoryId=2&categoryName=Electronics%20%26%20Accessories&subcategoryId=4&subcategoryName=Audio">Audio</a></li>
                                            <li><a href="product-grid-category.html?categoryId=2&categoryName=Electronics%20%26%20Accessories&subcategoryId=5&subcategoryName=Hard%20Drives,%20SSDs%20%26%20Storage">Hard Drives, SSDs & Storage</a></li>
                                        </ul>
                                    </li>
                                    <li class="dropdown-holder"><a href="product-grid-category.html?categoryId=3&categoryName=Printers">Printers</a>
                                        <ul class="hb-dropdown">
                                            <li><a href="product-grid-category.html?categoryId=3&categoryName=Printers&subcategoryId=6&subcategoryName=Inkjet%20Printers">Inkjet Printers</a></li>
                                            <li><a href="product-grid-category.html?categoryId=3&categoryName=Printers&subcategoryId=7&subcategoryName=Laser%20Printers">Laser Printers</a></li>
                                        </ul>
                                    </li>
                                    <div class="hb-right">
                                        <li><a href="deals.html">Deals</a></li>
                                        <li><a href="product-grid-general.html?searchType=New%20Arrivals">New Arrivals</a></li>
                                        <li><a href="product-grid-general.html?searchType=Best%20Sellers">Best Sellers</a></li>
                                    </div>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                <!-- Header Bottom Area End Here -->
            </header>
            <!-- Header Area End Here -->
            <!-- Begin Breadcrumb Area -->
            <div class="breadcrumb-area mb-20">
                <div class="container">
                    <div class="breadcrumb-content">
                        <ul>
                            <li style="color: #808080;">Home</li>
                            <li style="color: #808080;">Order Checkout</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Breadcrumb Area End Here -->
            <!-- Begin Checkout Contents Area -->
            <div class="checkout-contents-area mb-50">
                <div class="container">
                    <div class="row">
                        <div class="col-6">
                            <div class="section-title">
                                <p style="font-weight: 14px; color: #FF0000;">Fill in all the information below</p>
                            </div>
                            <div class="personal-div">
                                <div style="display: flex; justify-content: space-between;">
                                    <div>
                                        <h3 style="font-weight: bold; font-size: 16px;">Personal info</h3>
                                    </div>
                                    <div>
                                        <button id="sign-in-checkout-button" class="my-button" style="display: none;">Sign in to checkout instead</button>
                                        <button id="guest-checkout-button" class="my-button" style="display: none;" click="signOut()">Checkout as guest instead</button>
                                    </div>
                                </div>
                                <p style="font-style: italic;">Checking out as <span id="username" style="color: #808080;">guest</span></p>
                            </div>
                            <hr style="margin-bottom: 20px;">
                            <div class="adddress-div">
                                <div>
                                    <h3 style="font-weight: bold; font-size: 16px;">Shipping Information</h3>
                                    <p style="margin-bottom: 10px;">Provide accurate shipping details for correct delivery.</p>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <div id="addressContainer" style="margin-bottom: 20px;"></div>
                                    <div>
                                        <button id="change-primary-button" style="display: none;" class="my-button-inverse" style="height: 100%;"><a href="account-addresses.html">Change primary address</a></button>
                                    </div>      
                                </div>
                                <hr>
                                <label id="provide-address-text" for="" style="font-size: 16px;"></label>
                                <form id="moreText" action="" class="billing-address-form">
                                    <div class="row">
                                        <div class="col-12">
                                            <label for="">Street Address*</label>
                                            <input type="text" id="street-address" placeholder="Enter street address">
                                        </div>
                                        <div class="col-6">
                                            <label for="">City*</label>
                                            <input type="text" id="city" placeholder="Enter city">
                                        </div>
                                        <div class="col-6">
                                            <label for="">Zipcode*</label>
                                            <input type="text" id="zipcode" placeholder="Enter zipcode">
                                        </div>
                                        <div class="col-6">
                                            <label for="">State*</label>
                                            <select id="state-select" style="width: 100%;">
                                                <option value="">Please select a state</option>
                                                <option value="Johor">Johor</option>
                                                <option value="Kedah">Kedah</option>
                                                <option value="Kelantan">Kelantan</option>
                                                <option value="Melaka">Melaka (Malacca)</option>
                                                <option value="Negeri Sembilan">Negeri Sembilan</option>
                                                <option value="Pahang">Pahang</option>
                                                <option value="Perak">Perak</option>
                                                <option value="Perlis">Perlis</option>
                                                <option value="Pulau Pinang">Pulau Pinang (Penang)</option>
                                                <option value="Sabah">Sabah</option>
                                                <option value="Sarawak">Sarawak</option>
                                                <option value="Selangor">Selangor</option>
                                                <option value="Terengganu">Terengganu</option>
                                            </select>
                                        </div>
                                    </div>
                                    <label style="color: #000;">
                                        <input id="address-checkbox" type="checkbox" style="margin-right: 10px; position: relative; top: 2px;" disabled>
                                        <span>Use this shipping address</span> 
                                    </label>
                                </form>
                                <div style="background-color: #f0f2f2; margin-top: 10px;">
                                    <a href="#" id="moreLink" style="display: none;" onclick="showMore(event)" class="link-inverse">Fill up shipping information <i class="fa fa-angle-down" aria-hidden="true"></i></a>
                                    <a href="#" id="lessLink" onclick="showLess(event)" class="link-inverse">See less details <i class="fa fa-angle-up" aria-hidden="true"></i></a>
                                </div>
                            </div>
                            <hr style="margin-top: 20px; margin-bottom: 20px;">
                            <button class="my-button-inverse"><a href="shopping-cart.html">Back to cart</a></button>
                        </div>
                        <div class="col-2"></div>
                        <div class="col-4">
                            <div class="summary-container">
                                <h2 style="font-weight: bold; font-size: 18px;">Order Summary</h2>
                                <hr>
                                <div class="summary-item" style="font-size: 16px;">
                                    <div style="font-weight: bold;">Subtotal<span style="color: #808080; padding-left: 10px; font-weight: normal;"><span id="item-count">0</span> items</span></div>
                                    <div style="font-weight: bold;">RM <span id="subtotal">0.00</span></div>
                                </div>
                                <div class="summary-item">
                                    <div style="font-size: 12px;">Shipping Fee</div>
                                    <div style="font-size: 12px;">---</div>
                                </div>
                                <div class="summary-item">
                                    <div style="font-size: 12px;">Shipping Fee SST</div>
                                    <div style="font-size: 12px;">---</div>
                                </div>
                                <div class="summary-item" style="font-size: 16px;">
                                    <div style="font-weight: bold; color: #CD5C5C;">Order total</div>
                                    <div style="font-weight: bold;">RM <span id="total">0.00</span></div>
                                </div>
                                <hr>
                                <div class="payment-choice" style="padding-top: 10px; padding-bottom: 10px;">
                                    <div>Pay with</div>
                                    <div style="display: flex; align-items: center; margin-top: 10px;">
                                        <input type="radio" style="margin-right: 10px;" checked><img src="images/icon/Screenshot 2024-03-08 231705.png" alt="" width="15%" style="margin-right: 10px;"><span>Paypal</span>
                                    </div>    
                                </div>
                                <div class="paypal-buttons" style="padding-top: 10px; padding-bottom: 10px;">
                                    <div id="paypal-button-container"></div>
                                    <p id="result-message"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Checkout Contents Area End Here -->
            <!-- Begin Scroll Top  -->
            <div id="scrollToTop" class="mt-100">
                back to top
            </div>
            <!-- Scroll Top End Here -->
            <!-- Begin Footer Area -->
            <div class="footer pt-10 pb-10">
                <div class="container">
                    <div class="footer-wrap">
                        <div>
                            <ul style="margin-bottom: 20px;">
                                <li><a href="deals.html">Deals</a></li>
                                <li><a href="product-grid-general.html?searchType=New%20Arrivals">New products</a></li>
                                <li><a href="product-grid-general.html?searchType=Best%20Sellers">Best sales</a></li>
                                <li><a href="sign-in.html">Check Your Account</a></li>
                                <li><a href="sign-up.html">Be Our Customer</a></li>
                                <li><a href="account-orders.html">Track Your Orders</a></li>
                                <li><a href="contact.html">Contact us</a></li>
                            </ul>
                            <label style="color: #fff;" for="fname">Payment by</label>
                            <img src="images/icon/Credit-Card-Icons.jpg" width="20%" alt="">
                        </div>   
                        <div>
                            <span style="font-size: 12px;">&copy 2024 QuackCommerce.com. All Rights Reserved.</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer Area End Here -->
        </div>
        <!-- Body Wrapper End Here -->
        <!-- Modal -->
        <div class="modal" id="processingModal" tabindex="-1" data-backdrop="static" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body" style="display: flex; align-items: center;">
                        <div class="loader"></div>
                        <div style="margin-left: 20px; font-size: 16px;">Processing your order, please wait a moment</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Paypal Scripts -->
        <script src="https://www.paypal.com/sdk/js?client-id=AX4w4oVPgHYr4vzs6gAHUUWl_dZ86wqJ6hmcvrrbiiGQWm3A-Iy8A3pibRCvIYTX0MYZQkPF0tXx65ws&currency=MYR"></script>
        <script src="js/paypal.js"></script>
        <!-- Paypal Script -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha512-jGsMH83oKe9asCpkOVkBnUrDDTp8wl+adkB2D+//JtlxO4SrLoJdhbOysIFQJloQFD+C4Fl1rMsQZF76JjV0eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.usebootstrap.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js" integrity="sha512-bPs7Ae6pVvhOSiIcyUClR7/q2OAsRiovw4vAkX+zJbw3ShAeeqezq50RIIcIURq7Oa20rW2n2q+fyXBNcU9lrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="js/main.js"></script>
        <script>
           
            document.addEventListener('DOMContentLoaded', function() {

                checkSignInStatus();
                getCartNumber();

                const urlParams = new URLSearchParams(window.location.search);

                sessionStorage.setItem('isTherePrimary', false);

                // personal info area
                const userId = sessionStorage.getItem('userId'); 
                const username = sessionStorage.getItem('username');

                document.querySelector('#username').textContent = username;

                if (username === 'guest') {
                    document.querySelector('#sign-in-checkout-button').style.display = 'block';

                    // Event listener for sign-in-checkout-button
                    document.querySelector('#sign-in-checkout-button').addEventListener('click', function() {
                        window.location.href = 'sign-in.html';
                    });
                } else {
                    document.querySelector('#guest-checkout-button').style.display = 'block';

                    // Event listener for sign-in-checkout-button
                    document.querySelector('#guest-checkout-button').addEventListener('click', function() {
                        signOut();
                    });
                }

                // load user addresses
                const addressContainer = document.querySelector('#addressContainer');

                fetch(`http://localhost:8080/users/${userId}/addresses?primary=true`)
                    .then(response => {
                        return response.json()
                    })
                    .then(addresses => {

                        addresses.forEach((address, index) => {
                            addressContainer.innerHTML += `
                                <div>
                                    <label for="" style="font-size: 16px;">Your primary address</label>
                                    <div>
                                        <div style="font-size: 14px;">${address.streetAddress}</div>
                                        <div style="font-size: 14px;">${address.city}</div>
                                        <div style="font-size: 14px;">${address.zipcode}</div>
                                        <div style="font-size: 14px;">${address.state}</div>
                                        <div style="color: #808080;">Malaysia</div>
                                    </div>
                                </div>
                            `;

                            if (address.makePrimary) {
                                sessionStorage.setItem('isTherePrimary', true);
                            }

                            // set addresses to session
                            sessionStorage.setItem('streetAddress', address.streetAddress);
                            sessionStorage.setItem('city', address.city);
                            sessionStorage.setItem('zipcode', address.zipcode);
                            sessionStorage.setItem('state', address.state);
                        });

                        if (sessionStorage.getItem('isTherePrimary') === 'true') {
                            document.getElementById('change-primary-button').style.display = 'block';
                            document.getElementById('provide-address-text').textContent = 'Or provide another address';
                        } else {
                            document.getElementById('provide-address-text').textContent = 'Provide an address';
                        }

                    })
                    .catch(error => {
                        console.error(error);
                    });

                // Update basket summary
                const itemCountElement = document.getElementById('item-count');
                const subtotalElement = document.getElementById('subtotal');
                const totalElement = document.getElementById('total');
                
                itemCountElement.textContent = urlParams.getAll('selectedCartItemIds').length;

                fetch(`http://localhost:8080/carts/${userId}/cart-items/calculate-amount?selectedCartItemIds=${urlParams.getAll('selectedCartItemIds').join(',')}`)
                    .then(response => {
                        return response.json();
                    })
                    .then(amount => {
                        subtotalElement.textContent = amount.toFixed(2);
                        totalElement.textContent = amount.toFixed(2);
                        sessionStorage.setItem('amount', amount);
                    })
                    .catch(error => {
                        console.error(error);
                    });

                // check address events
                const streetAddressInput = document.getElementById('street-address');
                const cityInput = document.getElementById('city');
                const zipcodeInput = document.getElementById('zipcode');
                const stateSelect = document.getElementById('state-select');
                const addressCheckbox = document.getElementById('address-checkbox');
            
                streetAddressInput.addEventListener('input', checkFormFields);
                cityInput.addEventListener('input', checkFormFields);
                zipcodeInput.addEventListener('input', checkFormFields);
                stateSelect.addEventListener('change', checkFormFields);

                // Event listener for the address checkbox
                addressCheckbox.addEventListener('change', function() {
                    updateSessionStorage();
                });

                function checkFormFields() {
                    const streetAddress = streetAddressInput.value.trim();
                    const city = cityInput.value.trim();
                    const zipcode = zipcodeInput.value.trim();
                    const state = stateSelect.value;
            
                    if (streetAddress !== '' && city !== '' && zipcode !== '' && state !== '') {
                        addressCheckbox.disabled = false;
                    } else {
                        addressCheckbox.disabled = true;
                    }
                }
                // Function to update session storage when checkbox is checked
                function updateSessionStorage() {
                    if (addressCheckbox.checked) {
                        sessionStorage.setItem('streetAddress', streetAddressInput.value.trim());
                        sessionStorage.setItem('city', cityInput.value.trim());
                        sessionStorage.setItem('zipcode', zipcodeInput.value.trim());
                        sessionStorage.setItem('state', stateSelect.value);
                    }                
                }
            });
        </script>
        <script>
            function showMore(e) {
                e.preventDefault();
                document.getElementById('moreText').style.display = 'inline';
                document.getElementById('moreLink').style.display = 'none';
                document.getElementById('lessLink').style.display = 'inline';
            }
            function showLess(e) {
                e.preventDefault();
                document.getElementById('moreText').style.display = 'none';
                document.getElementById('moreLink').style.display = 'inline';
                document.getElementById('lessLink').style.display = 'none';
            }
        </script>
    </body>
</html>