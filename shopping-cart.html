<!doctype html>
<html class="no-js" lang="zxx">
    <head>
        <title>Cart - QuackCommerce.com</title>
        <link rel="icon" type="image/png" href="images/logo/site-logo-only.jpg">
        <!-- MATERIAL DESIGN ICONIC FONT -->
		<link rel="stylesheet" href="fonts/material-design-iconic-font/css/material-design-iconic-font.min.css">
        <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" >
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.css" integrity="sha512-UTNP5BXLIptsaj5WdKFrkFov94lDx+eBvbKyoe1YAfjeRPC+gT5kyZ10kOHCfNZqEui1sxmqvodNUx3KbuYI/A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <link rel="stylesheet" href="css/helper.css">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <!-- Begin Body Wrapper -->
        <div class="body-wrapper">
            <!-- Begin Header Area -->
            <header class="header">
                <!-- Begin Header Top Area -->
                <div class="header-top">
                    <div class="container">
                        <div class="ht-menu">
                            <span>Telephone Enquiry: 1-(800)-876-543</span>
                            <ul>
                                <li><a href="index.html">Home</a></li>
                                <li><a href="account-basic-info.html">My Account</a></li>
                                <li><a href="shopping-cart.html">Cart</a></li>
                                <li><a id="sign-in-link" href="sign-in.html">Sign In</a></li>    
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Header Top Area End Here -->
                <!-- Begin Header Middle Area -->
                <div class="header-middle">
                    <div class="container">
                        <div class="row">
                            <div class="col-3">
                                <div class="logo">
                                    <a href="index.html">
                                        <img src="images/logo/site-logo-only.jpg" alt="" style="width: 18%;">
                                        <span>QuackCommerce</span> 
                                    </a>
                                </div>
                            </div>
                            <div class="col-9">
                                <div class="hm-searchbox-area">
                                    <div class="hm-searchbox">
                                        <form id="searchForm">
                                            <select id="categorySelect">
                                                <option value="0">All</option>                         
                                                <option value="1">Laptops & Tablets</option>                     
                                                <option value="2">Electronics & Accessories</option>    
                                                <option value="3">Printers</option>
                                            </select>
                                            <input id="searchInput" type="text" placeholder="Search for anything at QuackCommerce online">
                                        </form>                                                                           
                                    </div>
                                    <p><a href="account-basic-info.html">Hello, <span id="greet-user">guest</span></a></p>
                                    <div class="cart-container">
                                        <a href="shopping-cart.html">
                                            <img src="images/icon/cart.png" alt="" width="50px">
                                            <span id="cart-number" class="cart-number">0</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Header Middle Area End Here -->
                <!-- Begin Header Bottom Area -->
                <div class="header-bottom header-sticky">
                    <div class="container">
                        <div class="hb-menu">
                            <nav>
                                <ul>
                                    <li class="dropdown-holder"><a href="product-grid-category.html?categoryId=1&categoryName=Laptops%20%26%20Tablets">Laptops & Tablets</a>
                                        <ul class="hb-dropdown">
                                            <li><a href="product-grid-category.html?categoryId=1&categoryName=Laptops%20%26%20Tablets&subcategoryId=1&subcategoryName=Laptops">Laptops</a></li>
                                            <li><a href="product-grid-category.html?categoryId=1&categoryName=Laptops%20%26%20Tablets&subcategoryId=2&subcategoryName=Tablets">Tablets</a></li>
                                        </ul>
                                    </li>
                                    <li class="dropdown-holder"><a href="product-grid-category.html?categoryId=2&categoryName=Electronics%20%26%20Accessories">Electronics & Accessories</a>
                                        <ul class="hb-dropdown">
                                            <li><a href="product-grid-category.html?categoryId=2&categoryName=Electronics%20%26%20Accessories&subcategoryId=3&subcategoryName=Keyboards%20%26%20Mice">Keyboards & Mice</a></li>
                                            <li><a href="product-grid-category.html?categoryId=2&categoryName=Electronics%20%26%20Accessories&subcategoryId=4&subcategoryName=Audio">Audio</a></li>
                                            <li><a href="product-grid-category.html?categoryId=2&categoryName=Electronics%20%26%20Accessories&subcategoryId=5&subcategoryName=Hard%20Drives,%20SSDs%20%26%20Storage">Hard Drives, SSDs & Storage</a></li>
                                        </ul>
                                    </li>
                                    <li class="dropdown-holder"><a href="product-grid-category.html?categoryId=3&categoryName=Printers">Printers</a>
                                        <ul class="hb-dropdown">
                                            <li><a href="product-grid-category.html?categoryId=3&categoryName=Printers&subcategoryId=6&subcategoryName=Inkjet%20Printers">Inkjet Printers</a></li>
                                            <li><a href="product-grid-category.html?categoryId=3&categoryName=Printers&subcategoryId=7&subcategoryName=Laser%20Printers">Laser Printers</a></li>
                                        </ul>
                                    </li>
                                    <div class="hb-right">
                                        <li><a href="product-grid-general.html?searchType=New%20Arrivals">New Arrivals</a></li>
                                        <li><a href="product-grid-general.html?searchType=Best%20Sellers">Best Sellers</a></li>
                                    </div>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                <!-- Header Bottom Area End Here -->
            </header>
            <!-- Header Area End Here -->
            <!-- Begin Breadcrumb Area -->
            <div class="breadcrumb-area mb-20">
                <div class="container">
                    <div class="breadcrumb-content">
                        <ul>
                            <li><a href="index.html">Home</a></li>
                            <li style="color: #808080;">Shopping Cart</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Breadcrumb Area End Here -->
            <!-- Begin Cart Contents Area -->
            <div class="cart-contents-area mb-50">
                <div class="container">
                    <div class="row">
                        <div class="col-8">
                            <div class="section-title">
                                <h2>Shopping Cart</h2>
                                <p style="float: right;">Last Updated: <span id="last-updated"></span></p>
                            </div><br><br>
                            <div class="cart-contents">
                                <table class="cart-table">
                                    <tr>
                                        <th><a href="" class="link-inverse" onclick="setSessionStatusToTrue()">Select all items</a></th>
                                        <th style="text-align: right;">Unit price</th>
                                    </tr>
                                    <!-- cart items will be inserted here -->
                                </table>
                                <br>
                                <div>
                                    <button class="my-button-inverse" id="clear-cart">Clear Cart</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="summary-container">
                                <h2 style="font-weight: bold; font-size: 18px;">Cart Summary</h2>
                                <hr>
                                <div class="summary-item">
                                    <div style="font-weight: bold;">Subtotal <span style="color: #808080; padding-left: 10px; font-weight: normal;"><span id="item-count">0</span> items</span></div>
                                    <div style="font-weight: bold;">RM <span id="subtotal">0.00</span></div>
                                </div>
                                <div class="summary-item">
                                    <div style="font-size: 12px;">Shipping Fee</div>
                                    <div style="font-size: 12px;">---</div>
                                </div>
                                <div class="summary-item">
                                    <div style="font-weight: bold;">Estimated total</div>
                                    <div style="font-style: italic;">Calculated at checkout</div>
                                </div>
                                <hr>
                                <div class="summary-item">
                                    <button class="my-button checkout-button" style="width: 100%;">Proceed to checkout</button>
                                </div>
                                <div class="error-message"></div>
                                <h3><span>or</span></h3>
                                <div class="summary-item">
                                    <button class="my-button-inverse" style="width: 100%;"><a href="index.html">Back to shopping</a></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cart Contents Area End Here -->
            <!-- Begin Scroll Top  -->
            <div id="scrollToTop" class="mt-100">
                back to top
            </div>
            <!-- Scroll Top End Here -->
            <!-- Begin Footer Area -->
            <div class="footer pt-10 pb-10">
                <div class="container">
                    <div class="footer-wrap">
                        <div>
                            <ul style="margin-bottom: 20px;">
                                <li><a href="deals.html">Deals</a></li>
                                <li><a href="product-grid-general.html?searchType=New%20Arrivals">New products</a></li>
                                <li><a href="product-grid-general.html?searchType=Best%20Sellers">Best sales</a></li>
                                <li><a href="sign-in.html">Check Your Account</a></li>
                                <li><a href="sign-up.html">Be Our Customer</a></li>
                                <li><a href="account-orders.html">Track Your Orders</a></li>
                                <li><a href="contact.html">Contact us</a></li>
                            </ul>
                            <label style="color: #fff;" for="fname">Payment by</label>
                            <img src="images/icon/Credit-Card-Icons.jpg" width="20%" alt="">
                        </div>   
                        <div>
                            <span style="font-size: 12px;">&copy 2024 QuackCommerce.com. All Rights Reserved.</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer Area End Here -->
        </div>
        <!-- Body Wrapper End Here -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha512-jGsMH83oKe9asCpkOVkBnUrDDTp8wl+adkB2D+//JtlxO4SrLoJdhbOysIFQJloQFD+C4Fl1rMsQZF76JjV0eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.usebootstrap.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js" integrity="sha512-bPs7Ae6pVvhOSiIcyUClR7/q2OAsRiovw4vAkX+zJbw3ShAeeqezq50RIIcIURq7Oa20rW2n2q+fyXBNcU9lrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="js/main.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {

                checkSignInStatus();
                getCartNumber();

                const userId = sessionStorage.getItem('userId');

                // fetch the user cart
                fetch(`http://localhost:8080/carts/${userId}`) 
                    .then(response => {
                        return response.json();
                    })
                    .then(cartDto => {
                        const cartTable = document.querySelector('.cart-table');
                        const dateElement = document.querySelector('#last-updated');

                        if (!cartDto.lastUpdated) {
                            dateElement.textContent = '';
                        } else {
                            const lastUpdated = new Date(cartDto.lastUpdated);

                            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                            const formattedDate = lastUpdated.toLocaleDateString('en-US', options);

                            dateElement.textContent = formattedDate;
                        }

                        if (cartDto.cartItemDtos.length === 0) {
                            const messageRow = document.createElement('tr');
                            messageRow.innerHTML = '<p style="text-align: center; font-size: 16px; color: #808080; position: relative; left: 100px;">Your cart is empty</p>';
                            cartTable.appendChild(messageRow);
                            return;
                        }

                        cartDto.cartItemDtos.forEach(cartItemDto => {
                            const cartItemElement = document.createElement('tr');
                            let selectOptions = '';
                            for (let i = 1; i <= 10; i++) {
                                const optionText = i === 1 ? 'Quantity: 1' : i;
                                selectOptions += `<option value="${i}" ${i === cartItemDto.quantity ? 'selected' : ''}>${optionText}</option>`;
                            }
                            cartItemElement.innerHTML = `
                                <td>
                                    <div class="row">
                                        <div class="col-4">
                                            <input type="checkbox" class="cart-checkbox" data-cart-item-id="${cartItemDto.cartItemId}">
                                            <div class="product-image">
                                                <a href="product-details.html?productId=${cartItemDto.productId}">
                                                    <img src="images/product/large-size/${cartItemDto.productName}.jpg" alt="Li's Product Image">
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-8">
                                            <div class="cart-product-details">
                                                <div>
                                                    <p class="product-name" style="font-size: 16px;"><a href="product-details.html?productId=${cartItemDto.productId}">${cartItemDto.productName}</a></p>
                                                </div>
                                                <div>
                                                    <div class="quantity-select">
                                                        <p style="color: #CD5C5C; margin-bottom: 5px;">Stock Left: <span data-product-id=${cartItemDto.productId} class="stock-count">${cartItemDto.quantityInStock}</span><span class="stock-count-text"></span></p>
                                                        <select data-cart-item-id="${cartItemDto.cartItemId}">
                                                            ${selectOptions}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div>
                                                    <ul class="cart-options">
                                                        <li><a href="" class="remove link-inverse" data-cart-item-id="${cartItemDto.cartItemId}">Remove</a></li>
                                                        <li><a href="product-details.html?productId=${cartItemDto.productId}" class="link-inverse">View details</a></li>      
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td style="text-align: right; width: 100px;">
                                    <p style="font-weight: bold;">RM ${cartItemDto.unitPrice.toFixed(2)}</p>
                                </td>
                            `;
                            cartTable.appendChild(cartItemElement);
                            
                            // Select elements within the cart item element
                            const checkbox = cartItemElement.querySelector('.cart-checkbox');
                            const productName = cartItemElement.querySelector('.product-name');
                            const stockCountText = cartItemElement.querySelector('.stock-count-text');

                            // Check if the quantityInStock is 0
                            if (cartItemDto.quantityInStock === 0) {
                                // Apply styles to the specific elements within the cart item
                                productName.style.color = '#808080';
                                stockCountText.textContent = ' - out of stock';
                                checkbox.disabled = true;
                            }
                         
                        });

                        // Set the checkboxes based on selectedCartItemIds
                        const urlParams = new URLSearchParams(window.location.search);
                        const selectedCartItemIds = {};

                        urlParams.getAll('selectedCartItemIds').forEach(cartItemId => {
                            selectedCartItemIds[cartItemId] = true;
                        });

                        const checkboxes = document.querySelectorAll('.cart-checkbox');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = selectedCartItemIds[checkbox.getAttribute('data-cart-item-id')];
                        });

                        // Add event listener to checkboxes
                        checkboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', () => {
                                event.preventDefault();
                                
                                setSessionStatus();
                            });
                        });

                        // select new quantities event
                        const selectElements = document.querySelectorAll('select');
                        selectElements.forEach(selectElement => {
                            selectElement.addEventListener('change', function(event) {
                                const newQuantity = parseInt(event.target.value);
                                const cartItemId = parseInt(selectElement.dataset.cartItemId);

                                fetch(`http://localhost:8080/carts/${userId}/cart-items/${cartItemId}?newQuantity=${newQuantity}`, {
                                    method: 'PUT',
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Failed to update cart item');
                                        }
                                        window.location.reload();
                                    })
                                    .catch(error => {
                                        console.error(error);
                                    });
                            });
                        });

                        // remove cart item event
                        document.querySelectorAll('.remove').forEach(item => {
                            item.addEventListener('click', function(event) {
                                event.preventDefault();

                                fetch(`http://localhost:8080/carts/${userId}/cart-items/${this.dataset.cartItemId}`, {
                                    method: 'DELETE',
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            return response.json().then(error => {
                                                throw new Error(error.message);
                                            });
                                        }
                                    })
                                    .then(() => {
                                        window.location.href = 'shopping-cart.html';
                                    })
                                    .catch(error => {
                                        console.error(error);
                                    });
                            });
                        });
                        
                    })
                    .catch(error => {
                        console.error(error);
                    });
                
                // clear cart event
                document.getElementById('clear-cart').addEventListener('click', function() {
                    event.preventDefault();

                    const userId = sessionStorage.getItem('userId');

                    // clear all the items in cart
                    fetch(`http://localhost:8080/carts/${userId}/cart-items/all`, {
                        method: 'DELETE'
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(error => {
                                    throw new Error(error.message);
                                });
                            }
                        })
                        .then(() => {
                            window.location.href = 'shopping-cart.html';
                        })
                        .catch(error => {
                            console.error(error);
                        });
                });

                // Update basket summary
                const itemCountElement = document.getElementById('item-count');
                const subtotalElement = document.getElementById('subtotal');
                
                const urlParams = new URLSearchParams(window.location.search);
                itemCountElement.textContent = urlParams.getAll('selectedCartItemIds').length;

                fetch(`http://localhost:8080/carts/${userId}/cart-items/calculate-amount?selectedCartItemIds=${urlParams.getAll('selectedCartItemIds').join(',')}`)
                    .then(response => {
                        return response.json();
                    })
                    .then(amount => {
                        subtotalElement.textContent = amount.toFixed(2);
                    })
                    .catch(error => {
                        console.error(error);
                    });

                // checkout event
                document.querySelector('.checkout-button').addEventListener('click', function(event) {
                    event.preventDefault();

                    const params = new URLSearchParams(window.location.search);

                    let redirectURL = `checkout.html?fromCart=true`;

                    if (params.has('selectedCartItemIds')) {
                        const cartItemIds = params.getAll('selectedCartItemIds');
                        const productQuantityMap = {};

                        cartItemIds.forEach((cartItemId, i) => {
                            const quantitySelect = document.querySelector(`select[data-cart-item-id="${cartItemId}"]`);
                            const productId = quantitySelect.parentNode.querySelector('.stock-count').getAttribute('data-product-id');
                            const quantity = parseInt(quantitySelect.value);

                            productQuantityMap[productId] = quantity;

                            redirectURL += `&selectedCartItemIds=${cartItemIds[i]}`;

                            // Add ampersand if it's not the last parameter
                            if (i < cartItemIds.length - 1) {
                                redirectURL += '&';
                            }
                        });
                        // Store product quantity map in session storage
                        sessionStorage.setItem('productQuantityMap', JSON.stringify(productQuantityMap));

                        window.location.href = redirectURL;
                    } else {
                        document.querySelector('.error-message').textContent = 'Please select at least an item';
                    }
                });

            });
        </script>
        <script>
            function setUrlParams(selectedCartItemIds) {
                const params = new URLSearchParams();
        
                for (const cartItemId in selectedCartItemIds) {
                    if (selectedCartItemIds.hasOwnProperty(cartItemId) && selectedCartItemIds[cartItemId]) {
                        params.append('selectedCartItemIds', cartItemId);
                    }
                }
        
                const currentUrl = new URL(window.location.href);
                currentUrl.search = params.toString();
        
                // Replace the current URL with the updated one
                window.history.replaceState({}, document.title, currentUrl.href);
        
                // Redirect to the updated URL
                window.location.href = currentUrl.href;
            }
            function setSessionStatus() {
                const selectedCartItemIds = {};
        
                // Iterate through each cart item checkbox
                const cartCheckboxes = document.querySelectorAll('.cart-checkbox');
                cartCheckboxes.forEach(checkbox => {
                
                    const cartItemId = checkbox.getAttribute('data-cart-item-id');
                    const isChecked = checkbox.checked;
                    selectedCartItemIds[cartItemId] = isChecked;
                });
        
                setUrlParams(selectedCartItemIds);
            }
            function setSessionStatusToTrue() {
                const selectedCartItemIds = {};
        
                // Iterate through each cart item checkbox
                const cartCheckboxes = document.querySelectorAll('.cart-checkbox');
                cartCheckboxes.forEach(checkbox => {
                    if (checkbox.disabled) {
                        return;
                    }
                    const cartItemId = checkbox.getAttribute('data-cart-item-id');
                    selectedCartItemIds[cartItemId] = true;
                });
        
                setUrlParams(selectedCartItemIds);
            }
        </script>        
    </body>
</html>
